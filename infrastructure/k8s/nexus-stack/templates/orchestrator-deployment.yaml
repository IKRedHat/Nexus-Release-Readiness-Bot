{{/*
=============================================================================
NEXUS ORCHESTRATOR DEPLOYMENT
=============================================================================
Central coordination service with ReAct AI engine
=============================================================================
*/}}
{{- if .Values.orchestrator.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "nexus.componentName" (dict "component" "orchestrator" "context" .) }}
  labels:
    {{- include "nexus.componentLabels" (dict "component" "orchestrator" "context" .) | nindent 4 }}
  annotations:
    {{- with .Values.global.commonAnnotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  {{- if not .Values.orchestrator.autoscaling.enabled }}
  replicas: {{ .Values.orchestrator.replicas }}
  {{- end }}
  revisionHistoryLimit: 5
  {{- with .Values.orchestrator.strategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "nexus.componentSelectorLabels" (dict "component" "orchestrator" "context" .) | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- with .Values.orchestrator.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        # Trigger rolling update on config/secret changes
        checksum/secret: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum | trunc 8 }}
      labels:
        {{- include "nexus.componentSelectorLabels" (dict "component" "orchestrator" "context" .) | nindent 8 }}
        {{- with .Values.global.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- include "nexus.imagePullSecrets" (dict "global" .Values.global "imageConfig" .Values.orchestrator.image) | nindent 6 }}
      serviceAccountName: {{ include "nexus.serviceAccountName" . }}
      
      # Security context
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      
      # Priority class
      {{- if .Values.orchestrator.priorityClassName }}
      priorityClassName: {{ .Values.orchestrator.priorityClassName }}
      {{- end }}
      
      # Termination grace period for graceful shutdown
      terminationGracePeriodSeconds: 30
      
      # Init containers - wait for dependencies
      initContainers:
        {{- if .Values.postgresql.enabled }}
        - name: wait-for-postgres
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for PostgreSQL..."
              until nc -z {{ .Release.Name }}-postgresql 5432; do
                sleep 2
              done
              echo "PostgreSQL is ready!"
          securityContext:
            {{- toYaml .Values.containerSecurityContext | nindent 12 }}
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
        {{- end }}
        {{- if .Values.redis.enabled }}
        - name: wait-for-redis
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for Redis..."
              until nc -z {{ .Release.Name }}-redis-master 6379; do
                sleep 2
              done
              echo "Redis is ready!"
          securityContext:
            {{- toYaml .Values.containerSecurityContext | nindent 12 }}
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
        {{- end }}
        {{- with .Values.orchestrator.initContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      
      containers:
        - name: orchestrator
          image: {{ include "nexus.image" (dict "imageConfig" .Values.orchestrator.image "global" .Values.global "Chart" .Chart) }}
          imagePullPolicy: {{ include "nexus.imagePullPolicy" (dict "imageConfig" .Values.orchestrator.image "global" .Values.global) }}
          
          securityContext:
            {{- toYaml .Values.containerSecurityContext | nindent 12 }}
          
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          
          # Environment variables
          env:
            # Service URLs
            - name: JIRA_AGENT_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "jira-agent" "port" 8081 "context" .) }}
            - name: GIT_CI_AGENT_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "git-ci-agent" "port" 8082 "context" .) }}
            - name: REPORTING_AGENT_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "reporting-agent" "port" 8083 "context" .) }}
            - name: SLACK_AGENT_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "slack-agent" "port" 8084 "context" .) }}
            - name: HYGIENE_AGENT_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "hygiene-agent" "port" 8085 "context" .) }}
            - name: RCA_AGENT_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "rca-agent" "port" 8006 "context" .) }}
            - name: ANALYTICS_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "analytics" "port" 8086 "context" .) }}
            - name: WEBHOOKS_URL
              value: {{ include "nexus.serviceUrl" (dict "name" "webhooks" "port" 8087 "context" .) }}
            
            # Database
            - name: POSTGRES_HOST
              value: {{ include "nexus.postgresHost" . }}
            - name: POSTGRES_DB
              value: {{ .Values.postgresql.auth.database | default "nexus" }}
            - name: POSTGRES_USER
              value: {{ .Values.postgresql.auth.username | default "nexus" }}
            
            # Redis
            - name: REDIS_URL
              value: {{ include "nexus.redisUrl" . }}
            
            # OpenTelemetry
            {{- if .Values.observability.tracing.enabled }}
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ .Values.observability.tracing.endpoint }}
            - name: OTEL_TRACES_SAMPLER_ARG
              value: {{ .Values.observability.tracing.samplingRatio | quote }}
            {{- end }}
            
            # User-defined environment variables
            {{- range $key, $value := .Values.orchestrator.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
          
          # Secrets
          envFrom:
            - secretRef:
                name: {{ include "nexus.secretName" (dict "component" "orchestrator" "existingSecret" .Values.orchestrator.existingSecret "context" .) }}
          
          # Probes
          {{- include "nexus.startupProbe" (dict "port" "http" "path" "/health") | nindent 10 }}
          {{- include "nexus.livenessProbe" (dict "port" "http" "path" "/live") | nindent 10 }}
          {{- include "nexus.readinessProbe" (dict "port" "http" "path" "/ready") | nindent 10 }}
          
          # Resources
          resources:
            {{- toYaml .Values.orchestrator.resources | nindent 12 }}
          
          # Lifecycle hooks
          {{- include "nexus.lifecycle" . | nindent 10 }}
          
          # Volume mounts
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /app/.cache
            {{- with .Values.orchestrator.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
        
        # Sidecars
        {{- with .Values.orchestrator.extraContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      
      # Volumes
      volumes:
        - name: tmp
          emptyDir: {}
        - name: cache
          emptyDir: {}
        {{- with .Values.orchestrator.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      
      # Scheduling
      {{- with .Values.orchestrator.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{- with .Values.orchestrator.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      # Anti-affinity for HA
      {{- if .Values.global.highAvailability.enabled }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "nexus.componentSelectorLabels" (dict "component" "orchestrator" "context" .) | nindent 20 }}
                topologyKey: kubernetes.io/hostname
            - weight: 50
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    {{- include "nexus.componentSelectorLabels" (dict "component" "orchestrator" "context" .) | nindent 20 }}
                topologyKey: topology.kubernetes.io/zone
        {{- with .Values.orchestrator.affinity }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- else }}
      {{- with .Values.orchestrator.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- end }}
      
      # Topology spread
      {{- if .Values.global.highAvailability.enabled }}
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              {{- include "nexus.componentSelectorLabels" (dict "component" "orchestrator" "context" .) | nindent 14 }}
      {{- end }}

---
# Service
apiVersion: v1
kind: Service
metadata:
  name: {{ include "nexus.componentName" (dict "component" "orchestrator" "context" .) }}
  labels:
    {{- include "nexus.componentLabels" (dict "component" "orchestrator" "context" .) | nindent 4 }}
  {{- with .Values.orchestrator.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.orchestrator.service.type }}
  ports:
    - port: {{ .Values.orchestrator.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "nexus.componentSelectorLabels" (dict "component" "orchestrator" "context" .) | nindent 4 }}

---
# HorizontalPodAutoscaler
{{- if .Values.orchestrator.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "nexus.componentName" (dict "component" "orchestrator" "context" .) }}
  labels:
    {{- include "nexus.componentLabels" (dict "component" "orchestrator" "context" .) | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "nexus.componentName" (dict "component" "orchestrator" "context" .) }}
  minReplicas: {{ .Values.orchestrator.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.orchestrator.autoscaling.maxReplicas }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.orchestrator.autoscaling.targetCPUUtilizationPercentage }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.orchestrator.autoscaling.targetMemoryUtilizationPercentage }}
    {{- with .Values.orchestrator.autoscaling.customMetrics }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 4
          periodSeconds: 15
      selectPolicy: Max
{{- end }}

---
# PodDisruptionBudget
{{- if .Values.orchestrator.pdb.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "nexus.componentName" (dict "component" "orchestrator" "context" .) }}
  labels:
    {{- include "nexus.componentLabels" (dict "component" "orchestrator" "context" .) | nindent 4 }}
spec:
  {{- if .Values.orchestrator.pdb.minAvailable }}
  minAvailable: {{ .Values.orchestrator.pdb.minAvailable }}
  {{- end }}
  {{- if .Values.orchestrator.pdb.maxUnavailable }}
  maxUnavailable: {{ .Values.orchestrator.pdb.maxUnavailable }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "nexus.componentSelectorLabels" (dict "component" "orchestrator" "context" .) | nindent 6 }}
{{- end }}
{{- end }}
