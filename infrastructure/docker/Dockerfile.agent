# syntax=docker/dockerfile:1.7
# =============================================================================
# Nexus Unified Agent - Production-Optimized Multi-Stage Dockerfile
# =============================================================================
#
# Universal Dockerfile for all Nexus specialist agents:
# - jira_agent (Port 8081) - Jira integration
# - git_ci_agent (Port 8082) - GitHub + Jenkins
# - reporting_agent (Port 8083) - Report generation
# - slack_agent (Port 8084) - Slack integration
# - jira_hygiene_agent (Port 8085) - Data quality checks
# - rca_agent (Port 8006) - Root cause analysis
#
# Build Args:
#   AGENT_NAME: Name of the agent (e.g., jira_agent)
#   AGENT_PORT: Port to expose (e.g., 8081)
#
# Build Example:
#   docker build \
#     --build-arg AGENT_NAME=jira_agent \
#     --build-arg AGENT_PORT=8081 \
#     -t nexus-jira-agent:latest \
#     -f Dockerfile.agent ../..
#
# =============================================================================

# -----------------------------------------------------------------------------
# Build Arguments
# -----------------------------------------------------------------------------
ARG PYTHON_VERSION=3.11
ARG UV_VERSION=0.4.18
ARG AGENT_NAME=jira_agent
ARG AGENT_PORT=8081

# =============================================================================
# Stage 1: UV Package Manager
# =============================================================================
FROM ghcr.io/astral-sh/uv:${UV_VERSION} AS uv

# =============================================================================
# Stage 2: Dependency Builder
# =============================================================================
FROM python:${PYTHON_VERSION}-slim-bookworm AS builder

ARG AGENT_NAME

# Copy UV binary
COPY --from=uv /uv /usr/local/bin/uv

# Install build dependencies
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        gcc \
        libpq-dev \
        libffi-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# -----------------------------------------------------------------------------
# Build Shared Library
# -----------------------------------------------------------------------------
COPY shared/setup.py shared/pyproject.toml* ./shared/
COPY shared/nexus_lib ./shared/nexus_lib

RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip wheel --wheel-dir /wheels ./shared/

# -----------------------------------------------------------------------------
# Build Agent Dependencies
# -----------------------------------------------------------------------------
COPY services/agents/${AGENT_NAME}/requirements.txt ./requirements.txt

RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip wheel --wheel-dir /wheels -r requirements.txt

# =============================================================================
# Stage 3: Production Runtime
# =============================================================================
FROM python:${PYTHON_VERSION}-slim-bookworm AS runtime

# Re-declare ARGs for this stage
ARG AGENT_NAME
ARG AGENT_PORT

# -----------------------------------------------------------------------------
# OCI Image Labels (Dynamic based on agent)
# -----------------------------------------------------------------------------
LABEL org.opencontainers.image.title="Nexus ${AGENT_NAME}" \
      org.opencontainers.image.description="Nexus specialized agent: ${AGENT_NAME}" \
      org.opencontainers.image.version="2.4.0" \
      org.opencontainers.image.vendor="Nexus Team" \
      org.opencontainers.image.authors="nexus@example.com" \
      org.opencontainers.image.licenses="MIT" \
      org.opencontainers.image.source="https://github.com/IKRedHat/Nexus-Release-Readiness-Bot"

# -----------------------------------------------------------------------------
# Environment Configuration
# -----------------------------------------------------------------------------
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONFAULTHANDLER=1 \
    PYTHONHASHSEED=random \
    # Application paths
    PYTHONPATH=/app:/app/shared:/app/services/agents/${AGENT_NAME} \
    # Agent configuration
    AGENT_NAME=${AGENT_NAME} \
    AGENT_PORT=${AGENT_PORT} \
    SERVICE_NAME=${AGENT_NAME} \
    SERVICE_PORT=${AGENT_PORT} \
    # Default mock mode for safety
    JIRA_MOCK_MODE=true \
    GITHUB_MOCK_MODE=true \
    JENKINS_MOCK_MODE=true \
    SLACK_MOCK_MODE=true \
    CONFLUENCE_MOCK_MODE=true

# -----------------------------------------------------------------------------
# System Setup
# -----------------------------------------------------------------------------
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
        libpq5 \
        ca-certificates \
        tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && groupadd --gid 1000 nexus \
    && useradd --uid 1000 --gid 1000 --shell /bin/bash --create-home nexus \
    && mkdir -p /app/shared /app/services/agents \
    && chown -R nexus:nexus /app

WORKDIR /app

# -----------------------------------------------------------------------------
# Install Dependencies
# -----------------------------------------------------------------------------
COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/*.whl && rm -rf /wheels

# -----------------------------------------------------------------------------
# Copy Application Code
# -----------------------------------------------------------------------------
COPY --chown=nexus:nexus shared/nexus_lib /app/shared/nexus_lib
COPY --chown=nexus:nexus services/agents/${AGENT_NAME} /app/services/agents/${AGENT_NAME}

# -----------------------------------------------------------------------------
# Health Check Script
# -----------------------------------------------------------------------------
COPY --chmod=755 <<EOF /usr/local/bin/healthcheck
#!/usr/bin/env python3
import sys, urllib.request, urllib.error, os
port = os.environ.get('AGENT_PORT', '8080')
try:
    with urllib.request.urlopen(f"http://localhost:{port}/health", timeout=5) as r:
        sys.exit(0 if r.status == 200 else 1)
except: sys.exit(1)
EOF

HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD ["/usr/local/bin/healthcheck"]

# -----------------------------------------------------------------------------
# Runtime Configuration
# -----------------------------------------------------------------------------
USER nexus
EXPOSE ${AGENT_PORT}
STOPSIGNAL SIGTERM

# -----------------------------------------------------------------------------
# Start Command (Uses shell form for variable expansion)
# -----------------------------------------------------------------------------
CMD python -m uvicorn \
    "services.agents.${AGENT_NAME}.main:app" \
    --host 0.0.0.0 \
    --port ${AGENT_PORT} \
    --workers 1 \
    --loop uvloop \
    --http httptools \
    --proxy-headers

